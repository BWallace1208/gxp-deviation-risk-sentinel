{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "event_schema_v0_1.json",
  "title": "GxP Deviation Risk Sentinel - Event Schema v0.1",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "event_id",
    "source_system",
    "event_type",
    "event_timestamp",
    "site",
    "area",
    "product_id",
    "dbr_template_id",
    "dbr_template_version",
    "step_code",
    "section_code",
    "operator_token",
    "operator_role"
  ],
  "properties": {
    "event_id": {
      "type": "string",
      "minLength": 8,
      "maxLength": 128,
      "description": "Unique event identifier generated by the source system."
    },
    "source_system": {
      "type": "string",
      "enum": ["DBR", "MES", "IMEX_DOC"],
      "description": "Originating system that emitted the event."
    },
    "event_type": {
      "type": "string",
      "enum": [
        "STEP_OPENED",
        "STEP_COMPLETED",
        "SUBMIT_ATTEMPTED",
        "SUBMIT_REJECTED_REQUIRED_MISSING",
        "SIGN_CAPTURED",
        "VERIFICATION_REQUIRED_MISSING",
        "SESSION_TIMEOUT",
        "OUT_OF_SEQUENCE_ATTEMPT",
        "CALC_STATUS_CHANGED",
        "HOLD_TRIGGERED",
        "EXCEPTION_TRIGGERED"
      ],
      "description": "Normalized event type emitted by the source system."
    },
    "event_timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "Server-side timestamp when the event occurred."
    },
    "site": { "type": "string", "minLength": 1, "maxLength": 64 },
    "area": { "type": "string", "minLength": 1, "maxLength": 64 },
    "suite": { "type": "string", "minLength": 1, "maxLength": 64 },
    "line": { "type": "string", "minLength": 1, "maxLength": 64 },

    "product_id": {
      "type": "string",
      "minLength": 1,
      "maxLength": 64,
      "description": "Non-sensitive product identifier (e.g., product family/process code)."
    },
    "batch_token": {
      "type": "string",
      "minLength": 8,
      "maxLength": 256,
      "description": "Pseudonymized batch reference token (optional but recommended)."
    },

    "dbr_template_id": { "type": "string", "minLength": 1, "maxLength": 64 },
    "dbr_template_version": { "type": "string", "minLength": 1, "maxLength": 32 },

    "page_number": { "type": "integer", "minimum": 1, "maximum": 5000 },
    "step_code": { "type": "string", "minLength": 1, "maxLength": 64 },
    "section_code": { "type": "string", "minLength": 1, "maxLength": 64 },

    "operator_token": {
      "type": "string",
      "minLength": 8,
      "maxLength": 256,
      "description": "Pseudonymized operator identifier (no raw IDs)."
    },
    "operator_role": {
      "type": "string",
      "enum": ["OPERATOR", "VERIFIER", "SUPERVISOR", "QA"],
      "description": "Role of the user associated with the event."
    },

    "calc_status": {
      "type": "string",
      "enum": ["PASS", "FAIL", "NOT_APPLICABLE"],
      "description": "Calculation status result only (no values). Only valid when event_type = CALC_STATUS_CHANGED."
    },
    "hold_code": {
      "type": "string",
      "minLength": 1,
      "maxLength": 64,
      "description": "Hold/exception code if emitted by the source system (no free text)."
    },

    "correlation_id": {
      "type": "string",
      "minLength": 8,
      "maxLength": 128,
      "description": "Optional identifier to correlate related events within a session or batch."
    }
  }
}
